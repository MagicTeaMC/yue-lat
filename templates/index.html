{% extends "base.html" %}
{% block content %}
<h1>Maoyue's URL Shortener</h1>
<script type="module" src="/static/altcha.min.js"></script>
<form method="post" id="shorten-form">
    <input type="hidden" name="authenticity_token" value="{{ authenticity_token }}">
    <input type="url" name="url" placeholder="https://example.com/very/long/url" required>
    <div style="margin: 1rem 0;">
        <altcha-widget
            challengeurl="data:application/json;base64,{{ altcha_challenge }}"
            hidefooter="false"
            hidelogo="false"
            name="altcha"
            strings='{"label":"Verify you are human","verified":"Verified","verifying":"Verifying...","error":"Verification failed","expired":"Verification expired"}'
        ></altcha-widget>
    </div>
    <button type="submit" id="submit-btn" disabled>Shorten</button>
</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const submitBtn = document.getElementById('submit-btn');
        const form = document.getElementById('shorten-form');
        const altchaWidget = document.querySelector('altcha-widget');
        
        if (altchaWidget) {
            altchaWidget.addEventListener('statechange', (event) => {
                if (event.detail.state === 'verified') {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            });
        }
        
        form.addEventListener('submit', function(e) {
            if (submitBtn.disabled) {
                e.preventDefault();
                alert('Please complete the verification first');
            }
        });
    });
</script>
{% endblock %}